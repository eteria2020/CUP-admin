<?php
$this->headLink()->appendStylesheet('/js/datatables/plugins/bootstrap/dataTables.bootstrap.css');
$this->headScript()
    ->appendFile('/js/datatables/media/js/jquery.dataTables.min.js')
    ->appendFile('/js/datatables/plugins/bootstrap/dataTables.bootstrap.js');

$csvData = $this->csvAnomaly->getCsvData();
$csvAmount = number_format(floatval(str_replace(',', '.', $csvData['Importo dell\'ordine'])), 2, ',', '');
$transactionAmount = null;
$updates = $this->csvAnomaly->getUpdates();

?>
<div class="page-content-wrapper">
    <div class="page-content">

        <!-- Title -->
        <h3 class="page-title">Dettagli Anomalia<?= $this->csvAnomaly->isResolved() ? ' (risolta)' : ''; ?></h3>

        <!-- BEGIN content container -->
        <div class="portlet-body">
            <div class="row-fluid">
                <div class="span6">

                    <?php echo $this->partial('partials/flash-messages.phtml', []); ?>

                    <!-- BEGIN csv data container -->
                    <div class="row">
                        <div class="col-lg-12">
                            <h3>Dati csv</h3>
                        </div>

                        <div class="col-lg-12">
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Numero</label>
                                    <div class="sng-info-box"><?= $csvData['Numero']; ?></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Data</label>
                                    <div class="sng-info-box"><?= $csvData['Data']; ?></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Cliente</label>
                                    <div class="sng-info-box">
                                        <?=
                                        $this->customer instanceof \SharengoCore\Entity\Customers ?
                                            '<a href="' . $this->url('customers/edit', ['id' => $this->customer->getId()])  . '">' . $this->customer->getId() .'</a>' :
                                            '-';
                                        ?>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Stato</label>
                                    <div class="sng-info-box"><?= $csvData['Stato']; ?></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Importo</label>
                                    <div class="sng-info-box"><?= $csvAmount; ?></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Dettagli errore</label>
                                    <div class="sng-info-box sng-info-box-fixed"><?= $csvData['Dettaglio Errore']; ?></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END csv data container -->

                    <!-- BEGIN transaction container -->
                    <?php
                    if ($this->csvAnomaly->getType() != \SharengoCore\Entity\CartasiCsvAnomaly::MISSING_FROM_TRANSACTIONS):
                        $transaction = $csvAnomaly->getTransaction();
                        $transactionAmount = number_format($transaction->getAmount() / 100, 2, ',', '');
                    ?>
                    <div class="row">
                        <div class="col-lg-12">
                            <h3>Dati transazione</h3>
                        </div>

                        <div class="col-lg-12">
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Data</label>
                                    <div class="sng-info-box"><?= $transaction->getDatetime()->format('d/m/Y H:i'); ?></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Esito</label>
                                    <div class="sng-info-box"><?= $transaction->getOutcome(); ?></div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Importo</label>
                                    <div class="sng-info-box"><?= $transactionAmount; ?></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php endif; ?>
                    <!-- END transaction container -->

                    <!-- BEGIN solutions container -->
                    <?php if (!$this->csvAnomaly->isResolved()): ?>
                    <div class="row">
                        <div class="col-lg-12">
                            <h3>Soluzione</h3>
                        </div>

                        <div class="col-lg-4">
                            <div class="form-group">
                                <label><?= $this->csvAnomaly->getTypeTranslated(); ?>:</label>
                                <p>Effettuare <?= $this->csvAnomaly->getAmount() > 0 ? 'NC' : 'fattura'; ?> di <?= number_format($this->csvAnomaly->getAmount() / 100, 2, ',', ''); ?> â‚¬ all'utente</p>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="form-group">
                                <form action="<?= $this->url('payments/csv-resolve', ['id' => $this->csvAnomaly->getId()]); ?>"
                                    method="post">
                                    <input class="btn btn-default btn-xs"
                                        type="submit"
                                        value="Segna come risolta">
                                    </input>
                                </form>
                            </div>
                        </div>
                    </div>
                    <?php endif; ?>
                    <!-- END solutions container -->

                    <!-- BEGIN note container -->
                    <div class="row">
                        <div class="col-lg-12">
                            <h3>Note</h3>
                        </div>

                        <div class="col-lg-12">

                            <!-- BEGIN notes table -->
                            <?php if (!empty($updates)): ?>
                            <h4>Elenco Note</h4>

                            <table id="notes-table" class="table table-striped table-bordered table-hover" id="js-invoices-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Id Webuser</th>
                                        <th>Nota</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($updates as $date => $note): ?>
                                    <tr>
                                        <td class="sng-date-column"><?= $date; ?></td>
                                        <td><?= $note['webuser']; ?></td>
                                        <td><?= $note['content']; ?></td>
                                    </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>

                            <!-- END notes table -->
                            <?php endif; ?>

                            <!-- BEGIN new note -->
                            <h4>Nuova Nota</h4>
                            <form action="<?= $this->url('payments/csv-add-note', ['id' => $this->csvAnomaly->getId()]); ?>"
                                method="post">

                                <textarea id="new-note" name="new-note" style="width: 100%" rows="5"></textarea><br><br>
                                <input class="btn btn-default btn-xs"
                                    type="submit"
                                    value="Aggiungi">
                                </input>

                            </form>
                            <!-- END new note -->

                        </div>
                    </div>
                    <!-- END note container -->

                </div>
            </div>
        </div>
        <!-- END content container -->

    </div>
</div>
